package provider

import (
	"context"
)

// Message –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç–µ
type Message struct {
	Role    string `json:"role"`
	Content string `json:"content"`
}

// ChatOptions —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞
type ChatOptions struct {
	SystemPrompt    string    `json:"system_prompt,omitempty"`
	History         []Message `json:"history,omitempty"`
	MaxTokens       int       `json:"max_tokens,omitempty"`
	Temperature     float64   `json:"temperature,omitempty"`
	ReasoningMode   string    `json:"reasoning_mode,omitempty"` // direct, step_by_step, experts
	JSONFormat      bool      `json:"json_format,omitempty"`
	JSONSchemaText  string    `json:"json_schema_text,omitempty"`
}

// Provider –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è AI-–ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
type Provider interface {
	// Name –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–º—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
	Name() string

	// Models –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π
	Models() []string

	// Chat –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç streaming –æ—Ç–≤–µ—Ç
	Chat(ctx context.Context, message string, opts *ChatOptions, onChunk func(string) error) error

	// SetModel —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –º–æ–¥–µ–ª—å –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
	SetModel(model string)

	// GetModel –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â—É—é –º–æ–¥–µ–ª—å
	GetModel() string
}

// ReasoningMode —Ä–µ–∂–∏–º—ã —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è
const (
	ReasoningDirect     = "direct"      // –ü—Ä—è–º–æ–π –æ—Ç–≤–µ—Ç
	ReasoningStepByStep = "step_by_step" // –ü–æ—à–∞–≥–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ
	ReasoningExperts    = "experts"      // –ì—Ä—É–ø–ø–∞ —ç–∫—Å–ø–µ—Ä—Ç–æ–≤
)

// BuildReasoningPrompt —Å–æ–∑–¥–∞–µ—Ç system prompt –¥–ª—è —Ä–µ–∂–∏–º–∞ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è
func BuildReasoningPrompt(mode string, basePrompt string) string {
	switch mode {
	case ReasoningStepByStep:
		return basePrompt + `

–ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û –†–ï–®–ï–ù–ò–Æ:
–†–µ—à–∞–π –∑–∞–¥–∞—á—É –ø–æ—à–∞–≥–æ–≤–æ:
1. –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∑–∞–¥–∞—á—É –∏ –æ–ø—Ä–µ–¥–µ–ª–∏, —á—Ç–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è –Ω–∞–π—Ç–∏
2. –†–∞–∑–±–µ–π —Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ —à–∞–≥–∏
3. –í—ã–ø–æ–ª–Ω–∏ –∫–∞–∂–¥—ã–π —à–∞–≥ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ, –æ–±—ä—è—Å–Ω—è—è —Å–≤–æ–∏ –¥–µ–π—Å—Ç–≤–∏—è
4. –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞ –ø—Ä–æ–≤–µ—Ä—è–π –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å
5. –í –∫–æ–Ω—Ü–µ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç–≤–µ—Ç

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
**–ê–Ω–∞–ª–∏–∑ –∑–∞–¥–∞—á–∏:**
[—Ç–≤–æ–π –∞–Ω–∞–ª–∏–∑]

**–®–∞–≥ 1:** [–æ–ø–∏—Å–∞–Ω–∏–µ]
[–≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ]

**–®–∞–≥ 2:** [–æ–ø–∏—Å–∞–Ω–∏–µ]
[–≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ]

... –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ ...

**–ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç–≤–µ—Ç:**
[—Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç]`

	case ReasoningExperts:
		return basePrompt + `

–†–ï–ñ–ò–ú –≠–ö–°–ü–ï–†–¢–ù–û–ì–û –°–û–í–ï–¢–ê:
–¢—ã –∫–æ–æ—Ä–¥–∏–Ω–∏—Ä—É–µ—à—å –≥—Ä—É–ø–ø—É —ç–∫—Å–ø–µ—Ä—Ç–æ–≤. –î–ª—è —Ä–µ—à–µ–Ω–∏—è –∑–∞–¥–∞—á–∏:

1. –ü—Ä–µ–¥—Å—Ç–∞–≤—å, —á—Ç–æ —É —Ç–µ–±—è –µ—Å—Ç—å –∫–æ–º–∞–Ω–¥–∞ –∏–∑ 3-4 —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤ —Ä–∞–∑–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π
2. –ö–∞–∂–¥—ã–π —ç–∫—Å–ø–µ—Ä—Ç –¥–æ–ª–∂–µ–Ω –¥–∞—Ç—å —Å–≤–æ–π –≤–∑–≥–ª—è–¥ –Ω–∞ –∑–∞–¥–∞—á—É
3. –ü–æ—Å–ª–µ –≤—Å–µ—Ö –º–Ω–µ–Ω–∏–π ‚Äî —Å–∏–Ω—Ç–µ–∑–∏—Ä—É–π –ª—É—á—à–µ–µ —Ä–µ—à–µ–Ω–∏–µ

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:

**üßÆ –≠–∫—Å–ø–µ—Ä—Ç-–∞–Ω–∞–ª–∏—Ç–∏–∫:**
[–∞–Ω–∞–ª–∏–∑ —Å —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è –ª–æ–≥–∏–∫–∏ –∏ –¥–∞–Ω–Ω—ã—Ö]

**üí° –≠–∫—Å–ø–µ—Ä—Ç-–ø—Ä–∞–∫—Ç–∏–∫:**
[–ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–¥—Ö–æ–¥ –∫ —Ä–µ—à–µ–Ω–∏—é]

**üîç –≠–∫—Å–ø–µ—Ä—Ç-–∫—Ä–∏—Ç–∏–∫:**
[–≤–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã]

**‚úÖ –°–∏–Ω—Ç–µ–∑ —Ä–µ—à–µ–Ω–∏–π:**
[–æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç —Å —É—á–µ—Ç–æ–º –≤—Å–µ—Ö –º–Ω–µ–Ω–∏–π]

**–ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç–≤–µ—Ç:**
[—Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ]`

	default: // direct
		if basePrompt != "" {
			return basePrompt
		}
		return "–û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ —Å—É—â–µ—Å—Ç–≤—É."
	}
}

// BuildJSONPrompt —Å–æ–∑–¥–∞–µ—Ç system prompt –¥–ª—è JSON-—Ñ–æ—Ä–º–∞—Ç–∞
func BuildJSONPrompt(schemaText string) string {
	prompt := "–í–∞—à –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å—Ç—Ä–æ–≥–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON.\n"

	if schemaText != "" {
		prompt += "–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞ –¥–æ–ª–∂–Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —Å–ª–µ–¥—É—é—â–µ–π —Å—Ö–µ–º–µ:\n" + schemaText + "\n"
	}

	prompt += "\n–í–ê–ñ–ù–û: –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–º JSON –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ—è—Å–Ω–µ–Ω–∏–π, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∏–ª–∏ markdown-—Ä–∞–∑–º–µ—Ç–∫–∏!"

	return prompt
}
